# Migration `20201111051502-rename-relation-models`

This migration has been generated by Ben Galloway at 11/11/2020, 5:15:02 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."CecilianInItem" DROP CONSTRAINT "CecilianInItem_cecilianId_fkey"

ALTER TABLE "public"."CecilianInItem" DROP CONSTRAINT "CecilianInItem_itemId_fkey"

ALTER TABLE "public"."FileOnItem" DROP CONSTRAINT "FileOnItem_fileId_fkey"

ALTER TABLE "public"."FileOnItem" DROP CONSTRAINT "FileOnItem_itemId_fkey"

ALTER TABLE "public"."ItemInCollection" DROP CONSTRAINT "ItemInCollection_addedById_fkey"

ALTER TABLE "public"."ItemInCollection" DROP CONSTRAINT "ItemInCollection_collectionId_fkey"

ALTER TABLE "public"."ItemInCollection" DROP CONSTRAINT "ItemInCollection_itemId_fkey"

ALTER TABLE "public"."TagOnArchiveItem" DROP CONSTRAINT "TagOnArchiveItem_itemId_fkey"

ALTER TABLE "public"."TagOnArchiveItem" DROP CONSTRAINT "TagOnArchiveItem_tagId_fkey"

ALTER TABLE "public"."TagOnCecilian" DROP CONSTRAINT "TagOnCecilian_cecilianId_fkey"

ALTER TABLE "public"."TagOnCecilian" DROP CONSTRAINT "TagOnCecilian_tagId_fkey"

CREATE TABLE "public"."ArchiveItemCecilian" (
"id" SERIAL,
"cecilianId" integer   ,
"itemId" integer   ,
"addedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"removedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."ArchiveItemFile" (
"id" SERIAL,
"fileId" integer   ,
"itemId" integer   ,
"addedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"removedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."CecilianTag" (
"id" SERIAL,
"cecilianId" integer   NOT NULL ,
"tagId" integer   NOT NULL ,
"addedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"removedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."ArchiveItemTag" (
"id" SERIAL,
"itemId" integer   NOT NULL ,
"tagId" integer   NOT NULL ,
"addedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"removedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."CollectionItem" (
"id" SERIAL,
"itemId" integer   NOT NULL ,
"collectionId" integer   NOT NULL ,
"itemIndex" text   ,
"addedById" integer   ,
"addedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL ,
"removedAt" timestamp(3)   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."LogEntry" (
"id" SERIAL,
"timestamp" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"logLine" text   NOT NULL ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."ArchiveItemCecilian" ADD FOREIGN KEY ("cecilianId")REFERENCES "public"."Cecilian"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ArchiveItemCecilian" ADD FOREIGN KEY ("itemId")REFERENCES "public"."ArchiveItem"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ArchiveItemFile" ADD FOREIGN KEY ("fileId")REFERENCES "public"."ArchiveFile"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ArchiveItemFile" ADD FOREIGN KEY ("itemId")REFERENCES "public"."ArchiveItem"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."CecilianTag" ADD FOREIGN KEY ("cecilianId")REFERENCES "public"."Cecilian"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CecilianTag" ADD FOREIGN KEY ("tagId")REFERENCES "public"."Tag"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."ArchiveItemTag" ADD FOREIGN KEY ("itemId")REFERENCES "public"."ArchiveItem"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."ArchiveItemTag" ADD FOREIGN KEY ("tagId")REFERENCES "public"."Tag"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CollectionItem" ADD FOREIGN KEY ("itemId")REFERENCES "public"."ArchiveItem"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CollectionItem" ADD FOREIGN KEY ("collectionId")REFERENCES "public"."ArchiveCollection"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CollectionItem" ADD FOREIGN KEY ("addedById")REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE

DROP TABLE "public"."AuditLog"

DROP TABLE "public"."CecilianInItem"

DROP TABLE "public"."FileOnItem"

DROP TABLE "public"."ItemInCollection"

DROP TABLE "public"."TagOnArchiveItem"

DROP TABLE "public"."TagOnCecilian"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201110065147-relation-name-tweaks..20201111051502-rename-relation-models
--- datamodel.dml
+++ datamodel.dml
@@ -1,26 +1,27 @@
 datasource DS {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider      = "prisma-client-js"
   binaryTargets = ["native", "rhel-openssl-1.0.x"]
 }
-// Slug generation function:
-// Math.random().toString(36).substring(2, 12).toLowerCase()
-// A 10-character slug allows 8.5M random generations
-// before having a 1% chance of collision
-// (by analysis of the birthday problem).
-
+// ---------------------------------------------------------
+//
+//  CECILIAN ARCHIVE
+//  Database Schema
+//  --BAG 10 November 2020
+//
 ///
 /// "Archiving is as much about pruning the hedge
 /// as it is about making sure it grows properly."
 /// -- Robyn Hunter
 ///    12 January 2020
 ///
+// ---------------------------------------------------------
 // ---------------------------------------------------------
 //
@@ -133,17 +134,17 @@
   slug       String  @unique
   displayName String
   otherNames String[]
   user       UserProfile? @relation("ProfileCecilian")
-  tags       TagOnCecilian[] /// Years, Events, Roles
-  inArchiveItems CecilianInItem[]
+  tags       CecilianTag[] /// Years, Events, Roles
+  inArchiveItems ArchiveItemCecilian[]
   authoredArchiveItems ArchiveItem[] @relation("ItemAuthor")
   createdAt  DateTime @default(now())
   updatedAt  DateTime @updatedAt
   deletedAt  DateTime?
 }
-model CecilianInItem {
+model ArchiveItemCecilian {
   id         Int     @id @default(autoincrement())
   cecilian   Cecilian? @relation(fields: [cecilianId], references: [id])
   cecilianId Int?
   item       ArchiveItem? @relation(fields: [itemId], references: [id])
@@ -157,15 +158,15 @@
   slug            String  @unique
   archiveRef      String
   type            ArchiveItemType
   associatedDate  DateTime?
-  collections     ItemInCollection[]
+  collections     CollectionItem[]
   notes           String?
   author          Cecilian? @relation("ItemAuthor", fields: [authorId], references: [id])
   authorId        Int?
-  tags            TagOnArchiveItem[] /// Years, Events, Roles
-  cecilians       CecilianInItem[]
-  files           FileOnItem[]
+  tags            ArchiveItemTag[] /// Years, Events, Roles
+  cecilians       ArchiveItemCecilian[]
+  files           ArchiveItemFile[]
   createdAt       DateTime @default(now())
   updatedAt       DateTime @updatedAt
   deletedAt       DateTime?
   createdBy       User? @relation("ItemCreatedBy", fields: [createdById], references: [id])
@@ -184,9 +185,9 @@
   kind        ArchiveFileKind
   name        String
   notes       String?
   url         String
-  items       FileOnItem[]
+  items       ArchiveItemFile[]
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
   deletedAt   DateTime?
   deletedBy   User? @relation("FileDeletedBy", fields: [deletedById], references: [id])
@@ -198,9 +199,9 @@
   PREVIOUSLY_DIGITISED
   CREATED_DIGITALLY
 }
-model FileOnItem {
+model ArchiveItemFile {
   id         Int     @id @default(autoincrement())
   file       ArchiveFile? @relation(fields: [fileId], references: [id])
   fileId     Int?
   item       ArchiveItem? @relation(fields: [itemId], references: [id])
@@ -278,18 +279,18 @@
   yearId        Int?
   createdAt     DateTime @default(now())
   updatedAt     DateTime @updatedAt
   deletedAt     DateTime?
-  cecilians     TagOnCecilian[]
-  archiveItems  TagOnArchiveItem[]
+  cecilians     CecilianTag[]
+  archiveItems  ArchiveItemTag[]
 }
 enum TagType {
   YEAR
   EVENT
   ROLE
 }
-model TagOnCecilian {
+model CecilianTag {
   id          Int      @id @default(autoincrement())
   cecilian    Cecilian @relation(fields: [cecilianId], references: [id])
   cecilianId  Int
   tag         Tag      @relation(fields: [tagId], references: [id])
@@ -297,9 +298,9 @@
   addedAt     DateTime @default(now())
   removedAt   DateTime?
 }
-model TagOnArchiveItem {
+model ArchiveItemTag {
   id         Int         @id @default(autoincrement())
   item       ArchiveItem @relation(fields: [itemId], references: [id])
   itemId     Int
   tag        Tag         @relation(fields: [tagId], references: [id])
@@ -325,9 +326,9 @@
   owner       User? @relation("CollectionOwner", fields: [ownerId], references: [id])
   ownerId     Int?
   viewPerms   ArchiveCollectionViewPerms @default(PUBLIC)
   editPerms   ArchiveCollectionEditPerms @default(OPEN)
-  items       ItemInCollection[]
+  items       CollectionItem[]
   createdAt   DateTime @default(now())
   createdBy   User @relation("CollectionCreatedBy", fields: [createdById], references: [id])
   createdById Int
   updatedAt   DateTime @updatedAt
@@ -348,9 +349,9 @@
   OPEN
   CLOSED
 }
-model ItemInCollection {
+model CollectionItem {
   id           Int     @id @default(autoincrement())
   item         ArchiveItem     @relation(fields: [itemId], references: [id])
   itemId       Int
   collection   ArchiveCollection @relation(fields: [collectionId], references: [id])
@@ -369,9 +370,9 @@
 //  AUDIT LOG
 //
 // ---------------------------------------------------------
-model AuditLog {
+model LogEntry {
   id         Int      @id @default(autoincrement())
   timestamp  DateTime @default(now())
   logLine    String
 }
```


